<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Private Videos</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Optimized notification styles */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 16px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 9999;
            animation: slideIn 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            max-width: 320px;
            backdrop-filter: blur(10px);
            font-size: 14px;
            font-weight: 500;
        }
        
        .notification.success {
            background: rgba(76, 175, 80, 0.15);
            color: #4CAF50;
            border: 1px solid rgba(76, 175, 80, 0.3);
        }
        
        .notification.error {
            background: rgba(244, 67, 54, 0.15);
            color: #f44336;
            border: 1px solid rgba(244, 67, 54, 0.3);
        }
        
        .notification.info {
            background: rgba(33, 150, 243, 0.15);
            color: #2196F3;
            border: 1px solid rgba(33, 150, 243, 0.3);
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        
        /* Loading spinner */
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 0.6s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Video player skeleton */
        .skeleton {
            background: linear-gradient(90deg, #1a1a1a 25%, #222 50%, #1a1a1a 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 8px;
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
    </style>
</head>
<body>
    <!-- Warning Modal -->
    <div id="warningModal" class="modal">
        <div class="modal-content">
            <div class="warning-icon">
                <i class="fas fa-user-secret"></i>
            </div>
            <h2>⚠️ PRIVATE VIDEO ACCESS</h2>
            <div class="warning-text">
                <p><strong>OPEN THIS PAGE AT YOUR OWN RISK!</strong></p>
                <p>This website hosts anonymous video content. Content may include:</p>
                <ul>
                    <li>User-uploaded videos without moderation</li>
                    <li>Potentially graphic or sensitive material</li>
                    <li>Completely anonymous content</li>
                </ul>
                <p>No registration or login required. All uploads are 100% anonymous.</p>
                <p>By clicking "ENTER", you confirm you are 18+ and understand the risks.</p>
            </div>
            <div class="modal-buttons">
                <button id="acceptBtn" class="btn btn-accept">
                    <i class="fas fa-door-open"></i> ENTER SITE
                </button>
                <button id="declineBtn" class="btn btn-decline">
                    <i class="fas fa-ban"></i> DECLINE & EXIT
                </button>
            </div>
            <p class="warning-note">If you decline, you will be redirected to fwrobby.site</p>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <i class="fas fa-user-secret"></i>
                <div class="logo-text">
                    <h1>Private Videos</h1>
                    <span class="tagline">Anonymous • No Signup</span>
                </div>
            </div>
            
            <!-- Upload Button -->
            <button id="openUploadModal" class="btn-upload-header">
                <i class="fas fa-cloud-upload-alt"></i>
                <span class="upload-text">Upload</span>
            </button>
        </header>

        <!-- Upload Modal -->
        <div id="uploadModal" class="modal hidden">
            <div class="modal-content upload-modal">
                <button class="close-modal" id="closeUploadModal">
                    <i class="fas fa-times"></i>
                </button>
                <h2><i class="fas fa-cloud-upload-alt"></i> Upload Video</h2>
                <p class="upload-info">Max 2 min • 30MB • 100% Anonymous</p>
                
                <div class="upload-area" id="uploadArea">
                    <i class="fas fa-file-video"></i>
                    <h3>Drop video here</h3>
                    <p>or tap to select file</p>
                    <input type="file" id="videoInput" accept="video/mp4,video/webm,video/quicktime" hidden>
                    <div class="file-info" id="fileInfo"></div>
                </div>
                
                <div class="upload-controls">
                    <input type="text" id="videoTitle" placeholder="Optional title (or leave blank)" maxlength="50">
                    <div class="upload-actions">
                        <button id="cancelUpload" class="btn btn-cancel">
                            Cancel
                        </button>
                        <button id="uploadBtn" class="btn btn-submit" disabled>
                            <i class="fas fa-upload"></i> Upload
                        </button>
                    </div>
                </div>
                
                <div class="upload-progress hidden" id="uploadProgress">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <span id="progressText">0%</span>
                </div>
                
                <div class="upload-rules">
                    <p><i class="fas fa-shield-alt"></i> No personal data collected</p>
                    <p><i class="fas fa-clock"></i> Videos auto-delete after 30 days</p>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <main class="main-content">
            <div class="videos-container">
                <div class="section-header">
                    <h2><i class="fas fa-play-circle"></i> Recent Videos</h2>
                    <div class="video-count" id="videoCount">Loading...</div>
                </div>
                
                <div class="video-grid" id="videoGrid">
                    <!-- Videos load here -->
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading videos...</p>
                    </div>
                </div>
            </div>
        </main>

        <!-- Video Player Modal -->
        <div id="videoModal" class="modal hidden">
            <div class="modal-content video-modal">
                <button class="close-modal" id="closeVideoModal">
                    <i class="fas fa-times"></i>
                </button>
                <div class="video-player-container">
                    <div class="video-loading skeleton" id="videoLoading"></div>
                    <video id="videoPlayer" controls playsinline preload="metadata">
                        Your browser doesn't support HTML5 video.
                    </video>
                </div>
                <div class="video-info">
                    <h3 id="modalVideoTitle">Loading...</h3>
                    <div class="video-meta">
                        <span><i class="fas fa-clock"></i> <span id="modalUploadTime">--</span></span>
                        <span><i class="fas fa-user-secret"></i> Anonymous</span>
                        <button id="copyLinkBtn" class="btn btn-small">
                            <i class="fas fa-link"></i> Copy Link
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="footer">
            <p><i class="fas fa-user-secret"></i> Private Videos • 100% Anonymous</p>
            <p class="footer-note">User-uploaded content • Viewer discretion advised</p>
        </footer>
    </div>

    <!-- Optimized JavaScript -->
    <script>
        // Supabase Configuration - Pre-initialize
        const SUPABASE_CONFIG = {
            url: 'https://tpskystunzgnbbgnrvnz.supabase.co',
            key: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRwc2t5c3R1bnpnbmJiZ25ydm56Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgwNTkyMjMsImV4cCI6MjA4MzYzNTIyM30.wEekEB2PyUvGcFFZ_dQvB9Ny0C2cM1v7NdY9_AcsnBU'
        };

        // Initialize on DOM ready
        document.addEventListener('DOMContentLoaded', function() {
            // Create storage immediately (will be populated when Supabase loads)
            window.storage = {
                // Simple upload method
                async uploadVideo(file, title, onProgress) {
                    try {
                        // Quick validation
                        if (!file || !file.type.startsWith('video/')) {
                            throw new Error('Please select a video file');
                        }
                        
                        if (file.size > 30 * 1024 * 1024) {
                            throw new Error('File too large (max 30MB)');
                        }

                        const supabase = window.supabase?.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.key);
                        if (!supabase) throw new Error('Connection error');

                        const fileExt = file.name.split('.').pop().toLowerCase();
                        const fileName = `vid_${Date.now()}_${Math.random().toString(36).slice(2, 8)}.${fileExt}`;
                        const filePath = `public/${fileName}`;

                        // Upload with progress
                        const { error: uploadError } = await supabase.storage
                            .from('videos')
                            .upload(filePath, file);

                        if (uploadError) throw uploadError;

                        const { data: urlData } = supabase.storage
                            .from('videos')
                            .getPublicUrl(filePath);

                        const videoData = {
                            title: title || `Video ${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`,
                            filename: fileName,
                            filepath: filePath,
                            url: urlData.publicUrl,
                            filesize: file.size,
                            filetype: file.type
                        };

                        const { data: dbData, error: dbError } = await supabase
                            .from('videos')
                            .insert([videoData])
                            .select()
                            .single();

                        return {
                            success: true,
                            video: dbData || videoData,
                            publicUrl: urlData.publicUrl
                        };

                    } catch (error) {
                        console.error('Upload error:', error);
                        return {
                            success: false,
                            error: error.message || 'Upload failed'
                        };
                    }
                },

                // Fast video fetching with caching
                async getAllVideos() {
                    try {
                        const supabase = window.supabase?.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.key);
                        if (!supabase) {
                            return { success: true, videos: [], count: 0 };
                        }

                        // Cache for 10 seconds
                        if (window._videoCache && Date.now() - window._videoCache.timestamp < 10000) {
                            return window._videoCache.data;
                        }

                        const { data, error } = await supabase
                            .from('videos')
                            .select('*')
                            .order('uploaded_at', { ascending: false })
                            .limit(50); // Limit for performance

                        if (error) throw error;

                        const result = {
                            success: true,
                            videos: data || [],
                            count: data?.length || 0
                        };

                        // Cache the result
                        window._videoCache = {
                            data: result,
                            timestamp: Date.now()
                        };

                        return result;

                    } catch (error) {
                        console.error('Fetch error:', error);
                        return {
                            success: true,
                            videos: [],
                            count: 0,
                            error: error.message
                        };
                    }
                }
            };

            console.log('Storage initialized');
        });
    </script>
    
    <!-- Load main script -->
    <script src="script.js" defer></script>
</body>
</html>